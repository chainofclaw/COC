groups:
  - name: coc-node-alerts
    rules:
      - alert: BlockProductionStopped
        expr: increase(coc_block_height[5m]) == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Block production stopped on {{ $labels.instance }}"
          description: "No new blocks produced in the last 5 minutes."

      - alert: ConsensusDegraded
        expr: coc_consensus_state != 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Consensus degraded on {{ $labels.instance }}"
          description: "Consensus state is {{ $value }} (expected 0 = healthy) for over 2 minutes."

      - alert: HighMemory
        expr: coc_process_memory_bytes > 2147483648
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Process memory exceeds 2GB (current: {{ $value | humanize1024 }})."

      - alert: PeerCountLow
        expr: coc_peers_connected < 2
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "Low peer count on {{ $labels.instance }}"
          description: "Connected peers is {{ $value }}, below threshold of 2."

      - alert: ForkDetected
        expr: max(coc_block_height) - min(coc_block_height) > 3
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Potential fork detected"
          description: "Block height delta across nodes exceeds 3 (delta: {{ $value }}). Nodes may have diverged."

      - alert: NodeOffline
        expr: up{job=~"coc-.*"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Node {{ $labels.instance }} is offline"
          description: "Prometheus cannot reach {{ $labels.instance }} for over 1 minute."

      - alert: MempoolBacklog
        expr: coc_tx_pool_pending > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Large mempool backlog on {{ $labels.instance }}"
          description: "Pending transactions ({{ $value }}) exceed 1000 for over 5 minutes."
