name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-node:
    name: Node Tests (744+)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: node/package-lock.json
      - run: cd node && npm ci
      - name: Run node tests
        run: |
          cd node
          node --experimental-strip-types --test --test-force-exit --test-reporter=spec --test-reporter-destination=stdout --test-reporter=junit --test-reporter-destination=node-results.xml src/*.test.ts src/**/*.test.ts
        env:
          NODE_ENV: test
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: node-test-results
          path: node/node-results.xml
          retention-days: 7

  test-services:
    name: Service Tests (102+)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: package-lock.json
      - run: npm ci --workspaces --include-workspace-root
      - name: Run service tests
        run: |
          node --experimental-strip-types --test --test-force-exit --test-reporter=spec --test-reporter-destination=stdout --test-reporter=junit --test-reporter-destination=service-results.xml services/**/*.test.ts nodeops/*.test.ts tests/**/*.test.ts
        env:
          NODE_ENV: test
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: service-test-results
          path: service-results.xml
          retention-days: 7

  test-contracts:
    name: Contract Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: contracts/package-lock.json
      - run: cd contracts && npm ci
      - run: cd contracts && npm test

  test-explorer:
    name: Explorer Build + Lib Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: explorer/package-lock.json
      - run: cd explorer && npm ci
      - name: Run explorer lib tests
        run: |
          node --experimental-strip-types --test --test-force-exit explorer/src/lib/*.test.ts
        env:
          NODE_ENV: test
      - name: Build explorer
        run: cd explorer && npm run build
        env:
          NEXT_TELEMETRY_DISABLED: "1"

  test-faucet:
    name: Faucet Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: faucet/package-lock.json
      - run: cd faucet && npm ci
      - name: Run faucet tests
        run: |
          node --experimental-strip-types --test --test-force-exit faucet/src/*.test.ts
        env:
          NODE_ENV: test

  test-gate:
    name: Test Gate
    needs: [test-node, test-services, test-contracts, test-explorer, test-faucet]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-node.result }}" != "success" ] || \
             [ "${{ needs.test-services.result }}" != "success" ] || \
             [ "${{ needs.test-contracts.result }}" != "success" ] || \
             [ "${{ needs.test-explorer.result }}" != "success" ] || \
             [ "${{ needs.test-faucet.result }}" != "success" ]; then
            echo "::error::One or more test suites failed"
            echo "Node: ${{ needs.test-node.result }}"
            echo "Services: ${{ needs.test-services.result }}"
            echo "Contracts: ${{ needs.test-contracts.result }}"
            echo "Explorer: ${{ needs.test-explorer.result }}"
            echo "Faucet: ${{ needs.test-faucet.result }}"
            exit 1
          fi
          echo "All test suites passed"
